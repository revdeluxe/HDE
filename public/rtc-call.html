<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC SIP Overlay Call</title>
    <style>
        #webrtc-overlay {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        #webrtc-call-box {
            background: #fff;
            padding: 2em;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
        #remoteVideo, #localVideo {
            width: 200px;
            height: 150px;
            background: #000;
            margin: 0.5em;
        }
        #call-controls button {
            margin: 0.5em;
        }
    </style>
</head>
<body>
    <div id="webrtc-overlay">
        <div id="webrtc-call-box">
            <h2 id="call-status">Incoming Call...</h2>
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" autoplay muted playsinline></video>
            <div id="call-controls">
                <button id="answerBtn">Answer</button>
                <button id="hangupBtn">Hang Up</button>
            </div>
        </div>
    </div>

    <!-- JsSIP library for SIP over WebRTC -->
    <script src="https://cdn.jsdelivr.net/npm/jssip@3/dist/jssip.min.js"></script>
    <script>
        // Configuration - replace with your SIP/Asterisk details
        const SIP_DOMAIN = 'wss://your-asterisk-server:8089/ws'; // WebSocket URL for Asterisk
        const SIP_URI = 'sip:username@your-asterisk-domain';     // Your SIP URI
        const SIP_USER = 'username';
        const SIP_PASS = 'password';

        // Overlay elements
        const overlay = document.getElementById('webrtc-overlay');
        const callStatus = document.getElementById('call-status');
        const answerBtn = document.getElementById('answerBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const remoteVideo = document.getElementById('remoteVideo');
        const localVideo = document.getElementById('localVideo');

        // JsSIP UA (User Agent) setup
        const socket = new JsSIP.WebSocketInterface(SIP_DOMAIN);
        const configuration = {
            sockets: [socket],
            uri: SIP_URI,
            password: SIP_PASS,
            session_timers: false
        };
        const ua = new JsSIP.UA(configuration);

        let currentSession = null;

        ua.on('newRTCSession', function(e) {
            const session = e.session;
            if (session.direction === 'incoming') {
                currentSession = session;
                overlay.style.display = 'flex';
                callStatus.textContent = 'Incoming Call...';

                answerBtn.onclick = () => {
                    session.answer({
                        mediaConstraints: { audio: true, video: true }
                    });
                };

                hangupBtn.onclick = () => {
                    session.terminate();
                };

                session.on('accepted', () => {
                    callStatus.textContent = 'Call in Progress';
                });

                session.on('ended', () => {
                    overlay.style.display = 'none';
                    remoteVideo.srcObject = null;
                    localVideo.srcObject = null;
                });

                session.on('failed', () => {
                    overlay.style.display = 'none';
                    remoteVideo.srcObject = null;
                    localVideo.srcObject = null;
                });

                session.connection.addEventListener('track', (event) => {
                    if (event.track.kind === 'video') {
                        remoteVideo.srcObject = event.streams[0];
                    }
                });

                navigator.mediaDevices.getUserMedia({ audio: true, video: true })
                    .then(stream => {
                        localVideo.srcObject = stream;
                    });
            }
        });

        ua.start();

        // To receive calls, user must be registered (logged in)
        // You can add a login form and store credentials in localStorage/sessionStorage for production use
    </script>
</body>
</html>